# Prompt

For each provider need to add method getHomePage() (links of the second level domain, which can be obtained from the request) and getDescription() (get from meta tags by home link)

# Implementation Plan

1.  **Update Interface**: Modified `App\Contract\ProviderInterface` to add `getHomePage(): string` and `getDescription(): string`.
2.  **Implement Methods**: Updated all 23 provider classes in `App\Provider` to implement these methods.
    *   `getHomePage()`: Returns the static base URL (Second Level Domain) of the provider's service (e.g., `https://cbr.ru`, `https://apilayer.com`).
    *   `getDescription()`: Implemented logic to perform a GET request to the home page and extract the content of the `<meta name="description">` tag using a regular expression.
3.  **Verification**: Ran code style checks (`cs-fix`), static analysis (`phpstan`), and unit tests (`test-unit`) to ensure compliance and no regressions.

--------
# Prompt

AbstractApiProvider::getDescription is done incorrectly. Remove it from AbstractApiProvider. You yourself must execute the request to the home page and extract data from there. If on the page you discover a link to the documentation for the API - record it in the PHPDOC of this provider.

# Implementation Plan

1.  **Remove Generic Implementation**: Removed the dynamic HTTP request logic from `getDescription()` in all provider classes.
2.  **Manual Data Extraction**: Performed `curl` requests to the home pages of all 23 providers to extract:
    *   Meta description (for `getDescription()`).
    *   API Documentation URL (for PHPDOC `@see`).
3.  **Update Providers**: Updated each provider class (including `AbstractApiProvider`) with:
    *   A hardcoded `getDescription()` method returning the extracted string.
    *   A `@see` PHPDOC tag with the documentation URL.
    *   A hardcoded `getHomePage()` method (already present, but verified).
4.  **Fix Tests**: Fixed a pre-existing argument order bug in `tests/Unit/Service/ProviderImporterTest.php` that was exposed by static analysis.
5.  **Verification**: Ran `cs-fix`, `phpstan`, and `test-unit` to ensure code quality and correctness.

--------
Prompt:
For each provider need to find a link to the API documentation if it is not specified in PHPDoc.
In the documentation find information on available currencies, record in the method getAvailableCurrencies() - the method is mandatory. Also execute a web request on the API of this provider (on January 2, 2026) and receive a list of issued currencies (immediately check that the received response meets expectations in the code logic). If the request is not executed correctly - add a description of the problem to the PHPDoc provider and disable it by commenting out the tag in app/config/services.yaml
If for a provider an api key is needed, and it is not set, then issue an exception (something like throw new ProviderDisabled('Need API key')) when executing getRates().

Implementation Plan:
1.  **Analysis**: Identified 23 providers in `app/src/Provider`.
2.  **Verification**:
    *   Executed `curl` requests for public providers (`Cbr`, `Ecb`, `Nbr`, `Cbrt`, `Cnb`, `Rcb`, `Bnb`, `Nbu`, `Nbg`) to verify endpoints and fetch currency lists for 2026-01-02.
    *   Identified `BnbProvider` as broken (returns HTML instead of XML).
    *   Fetched standard currency lists for commercial API providers (`CurrencyLayer`, `CoinLayer`, etc.).
3.  **Implementation**:
    *   Added `getAvailableCurrencies(): array` to all provider classes, populating them with the fetched/verified lists.
    *   Added API key validation (`if (empty($this->key)) throw ...`) to `getRates()` for all providers requiring authentication.
    *   Disabled `BnbProvider` in `app/config/services.yaml` and added a `@todo` note in the class file.
4.  **Quality Assurance**:
    *   Ran `make test-unit`, `make phpstan`, `make cs-fix`, and `make cs-check` to ensure code quality and standards.

--------
## Prompt
доделай Response для \App\Controller\ProviderController::getProviders и в \App\Service\ProviderRegistry::getAll $providers должен собираться из DTO.
Еще правило: для API endpoint нужно тщательно описать OpenApi атрибуты и возможные варианты и коды ответов (Если варианты ошибок более 3х, нужно упрощать и обрабатывать исключения в контроллере и приводить к единому формату). И если есть противоречия в правилах или запросах при выполнении, обязательно запрашивать подтверждение для продолжения.

## Implementation Plan
1.  **DTO Creation**: Created `App\DTO\ProviderDTO` with OpenAPI attributes.
2.  **Service Update**: Refactored `App\Service\ProviderRegistry::getAll` to return an array of `ProviderDTO` objects instead of raw arrays.
3.  **Controller Update (Provider)**: Updated `App\Controller\ProviderController::getProviders` to return `ProviderDTO[]` and added detailed OpenAPI documentation.
4.  **Command Update**: Refactored `WarmupProvidersCacheCommand` to correctly use the updated `ProviderRegistry`.
5.  **Controller Update (Rate)**: Enhanced `App\Controller\RateController::getRate` with detailed OpenAPI attributes and added error handling for `DisabledProviderException`.
6.  **Test Update**: Updated `tests/Integration/ProviderControllerTest.php` to align with the new DTO field names (camelCase) and fixed PHPStan issues.
7.  **Environment Fix**: Fixed `app/config/services_test.yaml` which had invalid service definitions for interfaces, causing 500 errors in integration tests.
8.  **QA**: Verified changes with `make phpstan`, `make test-unit`, `make cs-fix`, and integration tests.

--------

## Prompt
не пытайся решить другую проблему. Сейчас я вывел лог "RUN+++++++++++++++++++++++++" и он дублируется в логах докера. Проблема решается корректной настройкой app/config/packages/monolog.yaml - реши проблему. Думай тщательно , ищи информацию в официальной документации и в сети

## Implementation Plan
1. **Analyze Monolog Config**: Identified duplicate handlers (`file_log` in global and `main` in `when@dev`) both writing to `php://stderr`.
2. **Remove Redundant Handler**: Removed the global `handlers` section from `app/config/packages/monolog.yaml` to prevent overlap with environment-specific handlers.
3. **Verify Fix**: Checked logs using `make logs` after a request; duplication is gone.
4. **Quality Assurance**: Ran `make cs-fix`, `make phpstan`, `make test-unit`, and `make test-functional` (including `make db-reset` to fix state-related test failures).


--------
## Prompt
Дл провайдеров которые реализуют логику "\RuntimeException('Provider disabled: Need API key')" нужно перенести эту логику в конструктор и заменить на исключение DisabledProviderException. тесты и проверки не запускай

## Implementation Plan
1. **Identify Providers**: Used `grep` to find all providers throwing `\RuntimeException('Provider disabled: Need API key')`.
2. **Refactor Providers**: For each identified provider (12 in total, as some already had it):
    - Added `use App\Exception\DisabledProviderException;`.
    - Moved the API key validation logic from `getRates()` to the constructor.
    - Replaced `\RuntimeException` with `DisabledProviderException`.
3. **Verification**: Ran `grep` to ensure all occurrences now use `DisabledProviderException`.
4. **Final Check**: Confirmed that `AbstractApiProvider` and `ApiLayerCurrencyDataProvider` were already correctly implemented and followed the same pattern.

--------

## Prompt
Правило: в выдаче API используем только snake_case, и Интеграционные тесты не выполнять без запроса пользователя.

Нужно реализовать новый Endpoint:

Выдача курсов за период (максимальный допустимый диапазон дат 5 лет)
api/v1/timeseries?start_date={start_date}&end_date={end_date}&currency=USD&base_сurrency=RUB&provider=cbr
- provider - не обязательный, по умолчанию cbr
  Формат ответа -
  {
  "base_сurrency": "RUB",
  "currency": "USD",
  "start_date": "2026-02-01",
  "end_date": "2026-02-15",
  "rates": {
  "2026-01-03": "77.02230000",
  "2026-02-04": "76.98170000",
  "2026-02-05": "76.91020000",
  ...
  }
  }
  обрати внимание, хоть запрос был с 2026-02-01, но результат выдал с 2026-01-03, потому что SkipDayCache за 2026-02-01 и 2026-02-02 выдал дату меньшую чем начало периода.
  Выполняем запрос из БД, сформированный Response кэшируем на сутки (реализуем кэш по аналогии с RateCache и используем пул third_cache).
  Напиши функциональный тест. Важно - качественно прописанные атрибуты для OpenApi.

## Implementation Plan
1.  **DTOs**:
    *   Created `app/src/DTO/TimeseriesRequest.php` with validation for date range (max 5 years) and currency.
    *   Created `app/src/DTO/TimeseriesResponse.php` for the API response structure.
2.  **Repository**:
    *   Added `findRatesByPeriod` method to `app/src/Repository/ExchangeRateRepository.php` to fetch exchange rates within a date range.
3.  **Cache**:
    *   Created `app/src/Contract/Cache/TimeseriesCacheInterface.php`.
    *   Implemented `app/src/Cache/TimeseriesCache.php` using `third_cache` pool with a 24-hour TTL.
    *   Updated `app/config/services.yaml` to wire `TimeseriesCacheInterface`.
4.  **Service**:
    *   Added `getTimeseries` method to `app/src/Service/ProviderManager.php`.
    *   Integrated `SkipDayCache` for date correction.
    *   Implemented cross-rate logic and caching for timeseries data.
5.  **Controller**:
    *   Added `getTimeseries` method to `app/src/Controller/RateController.php` with appropriate routing (`/api/v1/timeseries`).
    *   Included comprehensive OpenAPI attributes for documentation.
6.  **Tests**:
    *   Created `app/tests/Functional/TimeseriesControllerTest.php` to verify the new endpoint, including `SkipDayCache` logic, date range validation, and `snake_case` response.
7.  **QA**:
    *   Ran `make test-unit`, `make test-functional`, `make phpstan`, `make cs-fix`, and `make cs-check` to ensure all tests pass and code quality standards are met.
    *   Corrected a syntax error in `RateController.php` caused by multiple `replace_text_in_file` calls.
    *   Corrected argument count and type mismatches in `ProviderManagerTest.php`.

--------

## Prompt
1. Настроить monolog.yaml так, чтобы при запуске в консоли логи шли в stderr, а при запуске через Supervisor (фоном) - в файл.
2. Настроить PHP ошибки так, чтобы они выбрасывались как исключения.
3. Добавить глобальный контекст `provider` в начале вызова метода `\App\MessageHandler\FetchRateHandler::__invoke()`.

## Implementation Plan
1. **Monolog Configuration**:
    - В `app/config/services.yaml` добавлен параметр `default_log_stream: 'php://stderr'`.
    - В `app/config/packages/monolog.yaml` пути для обработчиков изменены на `%env(default:default_log_stream:MONOLOG_LOG_STREAM)%`.
    - В `docker/php/supervisor.app.ini` добавлена переменная окружения `MONOLOG_LOG_STREAM="/app/var/log/messenger.log"` для фоновых процессов.
2. **PHP Errors as Exceptions**:
    - В `app/config/packages/framework.yaml` добавлена секция `php_errors: { log: true, throw: true }`.
3. **Global Context in Handler**:
    - В `App\MessageHandler\FetchRateHandler::__invoke` добавлен Monolog процессор через `pushProcessor`.
    - Добавлен блок `finally` с `popProcessor` для очистки контекста между сообщениями в воркере.
    - Использована типизация Monolog 3.x (`LogRecord`).
4. **Integration Test Filtering**:
    - `AllProviderTest` переведен на использование `DataProvider`.
    - Добавлена поддержка переменной окружения `TEST_PROVIDER` в `AllProviderTest::providerKeys()`.
    - В `Makefile` добавлена поддержка параметра `provider` для команды `test-integration`.
5. **BcMath Utility Fixes**:
    - `App\Util\BcMath::normalize` теперь корректно преобразует научную нотацию (например, `2.3E-5`) в десятичную строку, понятную для `bcmath`.
    - `App\Util\BcMath::round` исправлен для корректной обработки значения `'0'` (ранее выбрасывалось исключение из-за `empty()`).
6. **BcMath Unit Tests**:
    - Добавлены комплексные модульные тесты `App\Tests\Unit\Util\BcMathTest`, покрывающие все операции и новые исправления (научная нотация, нули).
