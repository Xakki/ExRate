## Prompt
Проверь каждого (активного) провайдера. 
1) getRates() переименовать в getRatesByDate()
2) url вынести в конфиг , как у CbrProvider

## Implementation Plan
1. **Renaming Method**: Renamed `getRates(\DateTimeImmutable $date)` to `getRatesByDate(\DateTimeImmutable $date)` in `ProviderInterface` and all implementing provider classes.
2. **Updating Callers**: Updated `ProviderImporter` and `SyncProviderCurrenciesCommand` to call the renamed `getRatesByDate` method.
3. **Externalizing URLs**: 
    - Moved hardcoded URLs from provider classes to `app/config/services.yaml`.
    - Updated constructors of all providers to accept a `$url` string parameter.
    - Updated provider logic to use the injected `$url` (handling base URL concatenation and query parameters appropriately).
4. **Service Configuration**: Updated all provider service definitions in `services.yaml` to include the `$url` argument.
5. **Quality Assurance**:
    - Fixed functional tests (`RateControllerTest` and `TimeseriesControllerTest`) that were failing due to environment/validation message changes.
    - Updated `ProviderImporterTest` to use the renamed `getRatesByDate` method in mocks.
    - Ran `make phpstan`, `make cs-fix`, `make test-unit`, and `make test-functional` to ensure system stability.

## Git Comment Summary
refactor: rename provider getRates to getRatesByDate and externalize URLs to config

- Rename getRates() to getRatesByDate() across ProviderInterface and all providers
- Move hardcoded API URLs from provider classes to services.yaml configuration
- Update provider constructors to accept injected $url parameter
- Fix unit and functional tests to align with changes and environment expectations

---

## Prompt
надо сделать чтобы url для провайдеров формировался с шаблоном 
Например CbrProvider 
 - https://cbr.ru/scripts/XML_daily.asp?date_req={date:d/m/Y} (Тут базовый курс не уазывается, потому что он жестко задан самим провайдером)

Например ApiLayerExchangeRatesDataProvider 
- https://api.apilayer.com/exchangerates_data/{date:Y-m-d}?base={baseCurrency}  

И еще: вместо \RuntimeException нужно сделать \App\Exception\FailedProviderException

## Implementation Plan
1. **Created FailedProviderException**: Added `App\Exception\FailedProviderException` to replace generic `RuntimeException` in providers.
2. **Created UrlTemplateTrait**: Implemented `App\Util\UrlTemplateTrait` with `prepareUrl` method to handle placeholders like `{date:format}`, `{baseCurrency}`, and `{apiKey}`.
3. **Updated Configuration**: Refactored `app/config/services.yaml` to use URL templates for several providers (`CbrProvider`, `ApiLayerExchangeRatesDataProvider`, `AbstractApiProvider`, `RcbProvider`, `NbuProvider`, `NbgProvider`, `XchangeApiProvider`).
4. **Refactored Providers**: 
    - Updated providers to use `UrlTemplateTrait` and the new template-based URL generation logic.
    - Replaced all occurrences of `\RuntimeException` with `FailedProviderException` across all provider classes.
5. **Quality Assurance**:
    - Ran `make test-unit` and `make test-functional` (all passed).
    - Ran `make phpstan` and fixed missing imports/incorrect namespaces.
    - Ran `make cs-fix` to ensure coding standards.

## Git Comment Summary
refactor: implement URL templates for providers and use FailedProviderException

- Add UrlTemplateTrait to handle {date}, {baseCurrency}, and {apiKey} placeholders in provider URLs
- Update services.yaml with URL templates for multiple providers
- Create FailedProviderException and replace \RuntimeException in all providers
- Refactor providers to use the new URL preparation logic

---

## Prompt
В \App\Service\ProviderImporter::fetchAndSaveRates() , полученные данные из getRatesByDate() , нужно сверить с getAvailableCurrencies() провайдера, если есть отличия, писать в лог notice

## Implementation Plan
1. **Modified ProviderImporter**:
    - Added `App\Contract\ProviderInterface` import.
    - Implemented `checkCurrencyConsistency` private method to compare fetched rates with provider's available currencies.
    - Integrated `checkCurrencyConsistency` call into `fetchAndSaveRates` method.
    - Logging a `notice` with details of missing and extra currencies when a mismatch is detected.
2. **Updated Unit Tests**:
    - Updated `ProviderImporterTest` to mock `getEnum()` and `getAvailableCurrencies()` for `ProviderInterface`.
    - Added `testFetchAndSaveRatesWithCurrencyMismatch` to verify that the notice is correctly logged when currencies don't match.
3. **Quality Assurance**:
    - Ran `make phpstan` (OK).
    - Ran `make cs-fix` (Fixed unrelated files and ensured my changes were clean).
    - Ran `make test-unit` (33 tests, all passed).
    - Ran `make test-functional` (7 tests, all passed).

## Git Comment Summary
feat: add currency consistency check in ProviderImporter

- Implement checkCurrencyConsistency in ProviderImporter::fetchAndSaveRates
- Compare fetched currencies with provider's available currencies list
- Log a notice when a mismatch (missing or extra currencies) is found
- Update and add unit tests to cover currency consistency verification

---

## Prompt
1) Упорядочить конфиги провайдера в app/config/services.yaml по алфавиту названия класса
2) Также упорядочить ключи в app/.env.local_dist (Добавить отсутствующие с сылками на документацию из phpdoc провайдера)

## Implementation Plan
1. Проанализировал `app/config/services.yaml` и список провайдеров в `app/src/Provider`.
2. Пересобрал секцию `# Providers` в `services.yaml`, отсортировав блоки по имени класса.
3. Собрал все переменные окружения, используемые провайдерами, и сопоставил их со ссылками на документацию из аннотаций `@see`.
4. Обновил `app/.env.local_dist`: отсортировал ключи по алфавиту, добавий недостающий `FRED_API_KEY` и актуальные ссылки.
5. Выполнил QA: `make test-unit`, `make test-functional`, `make cs-fix`.

## Git Comment Summary
chore: sort provider services alphabetically and update .env.local_dist with doc links

---

## Prompt
Используй \App\Util\RequestTrait::jsonRequest() Для всех провайдеров

## Implementation Plan
1. **Modified RequestTrait**:
    - Fixed typo `$heders` -> `$headers`.
    - Added PHPStan type hints for `$headers` and return type.
    - Added `$options` parameter to support additional `HttpClient` configurations (like `query`).
2. **Refactored JSON Providers**:
    - Added `use RequestTrait;` to 24 JSON-based providers.
    - Replaced manual `httpClient->request()`, `getContent()`, and `json_decode()`/`toArray()` calls with `$this->jsonRequest()`.
    - Simplified error handling by leveraging `jsonRequest`'s internal behavior.
    - Handled providers using query parameters (Binance, Moex, Fred, WorldBank, Frankfurter, OpenExchangeRates, FastForex, Xignite, CurrencyLayer, CoinLayer, CurrencyConverter, CurrencyDataFeed, ExchangeRatesApi).
3. **Fixed PHPStan Errors**:
    - Corrected redundant null-coalesce operators in `FastForexProvider` and `XchangeApiProvider`.
    - Ensured `json_encode` always returns a string in `BanxicoProvider`.
4. **Quality Assurance**:
    - Verified that XML (ECB, CBR, CBRT, NBU, NBR, BNB) and Text (CNB) providers remain unchanged as they are not JSON-compatible.
    - Ran `make phpstan` (OK).
    - Ran `make test-unit` and `make test-functional` (All passed).
    - Ran `make cs-fix`.

## Git Comment Summary
refactor: use RequestTrait::jsonRequest in all JSON-based providers

- Update RequestTrait to fix typos, add type hints, and support $options
- Refactor all JSON providers to use $this->jsonRequest() instead of direct HttpClient calls
- Simplify response parsing and error handling in providers
- Ensure compatibility for providers using query parameters
- Fix static analysis issues in Banxico, FastForex, and XchangeApi providers

---

## Prompt
1) Создать DTO/Currency.php с атрибутами OpenAPI
- name: до 12 символов (пример: BRL)
- title: Полное навзвание (пример: Brazilian Reals)
- descr: описание (по умолчанию пусто)
- frequency: FrequencyEnum [Daily, Weekly, Monthly] (по умолчанию Daily)
- observationStart: string [date, d-m-Y] (default NULL)
- observationEnd: string [date, d-m-Y] (default NULL)

2) \App\Contract\ProviderInterface::getAvailableCurrencies() теперь выдает <string, Currency>

3) Получи данные из FRED API и обнови \App\Provider\FredProvider->getAvailableCurrencies() используя все доступные данные, добавь те что доступны (observation_end="2026-02-06")

## Implementation Plan
1. **Created FrequencyEnum**: Added `App\Enum\FrequencyEnum` with `Daily`, `Weekly`, and `Monthly` cases.
2. **Created Currency DTO**: Implemented `App\DTO\Currency` with OpenAPI attributes and validation constraints.
3. **Updated ProviderInterface**: Changed return type hint for `getAvailableCurrencies` to `array<string, Currency>`.
4. **Refactored All Providers**: 
    - Updated all 30 providers to return an associative array of `Currency` objects.
    - Used a PHP automation script to transform simple string arrays and expressions (like `array_keys`) into the new `Currency` format.
5. **Enriched FredProvider**:
    - Fetched actual series data from FRED API.
    - Updated `SERIES_MAP` and corrected `CHF`/`ZAR` mapping bugs.
    - Fully implemented `getAvailableCurrencies` with real titles and observation periods.
6. **Updated Callers & DTOs**:
    - Updated `ProviderDTO` to use `Currency` DTO in OpenAPI documentation.
    - Updated `SyncProviderCurrenciesCommand` to support the new `Currency` format when syncing files.
    - Fixed `ProviderImporter` consistency check and `AllProviderTest` integration test.
7. **Quality Assurance**:
    - Fixed `RequestTrait` to correctly handle `LimitException` parameters from Symfony headers.
    - Ran `make phpstan`, `make cs-fix`, `make test-unit`, and `make test-functional`.

## Git Comment Summary
feat: introduce Currency DTO and enrich FredProvider with metadata

- Create Currency DTO and FrequencyEnum with OpenAPI support
- Update ProviderInterface::getAvailableCurrencies to return array<string, Currency>
- Refactor all providers to support the new currency structure
- Enrich FredProvider with real currency titles and observation dates from FRED API
- Fix bugs in FredProvider series mapping (CHF, ZAR)
- Update SyncProviderCurrenciesCommand and ProviderImporter to handle Currency DTOs
- Fix type errors in RequestTrait and integration tests

---
**Prompt**: реализуй у провайдеров метод \App\Contract\ProviderInterface::getDaysLag() , с значением 0
**Implementation Plan**:
1. Identified all classes implementing \App\Contract\ProviderInterface.
2. Implemented getDaysLag(): int returning 0 in AbstractApiProvider, BankOfCanadaProvider, and all other 28 provider classes.
3. Fixed a syntax error (empty if block) in app/src/Service/ProviderImporter.php that was causing PHPStan to fail.
4. Verified changes with make phpstan, make cs-fix, make test-unit, and make test-functional.
**Git Comment Summary**: Implement getDaysLag() returning 0 in all providers and fix syntax error in ProviderImporter.

---

## Prompt
для \App\DTO\Currency::observationStart заменить формат даты на 'Y-m-d'.
Правило: для всего проекта , формат даты по умолчанию 'Y-m-d' для хранения в БД и в коде.

## Implementation Plan
1. **Updated Currency DTO**: Changed the date format in `App\DTO\Currency` from `d-m-Y` to `Y-m-d` for `observationStart` and `observationEnd` in OpenAPI examples.
2. **Updated DTO Methods**: Refactored `getObservationStart()` in `Currency.php` to use `DateTimeImmutable::createFromFormat('Y-m-d', ...)`.
3. **Refactored Providers**: Updated `FredProvider` to use `Y-m-d` format for all hardcoded `observationStart` dates in `getAvailableCurrencies()`.
4. **Data Consistency**: Verified that the project rule for `Y-m-d` date format is respected across `app/src` (no remaining `d-m-Y` strings found in code).
5. **Quality Assurance**: Ran `make test-unit` to ensure date parsing and DTO logic remain functional.

## Git Comment Summary
refactor: change default date format to Y-m-d across the project

- Update Currency DTO to use Y-m-d for observation dates and OpenAPI examples
- Reformat hardcoded dates in FredProvider to Y-m-d
- Ensure consistency with project-wide date format rule

---

## Prompt
Для провайдеров работающие с xml нужно переделать на работу с методом \App\Util\RequestTrait::xmlRequest

## Implementation Plan
1. **Modified RequestTrait**: Fixed a PHPStan warning by removing a redundant `instanceof \SimpleXMLElement` check in `xmlRequest()`.
2. **Refactored XML Providers**:
    - Added `use RequestTrait;` and updated constructors to support it in 6 providers: `EcbProvider`, `NbuProvider`, `CbrtProvider`, `CbrProvider`, `NbrProvider`, and `BnbProvider`.
    - Replaced manual `httpClient->request()` and `simplexml_load_string()` calls with `$this->xmlRequest()` or used the trait's `request()` method where status code checks were necessary.
    - Handled specific retry logic in `CbrtProvider` and special response checks in `BnbProvider`.
3. **Fixed PHPStan in Tests**: Corrected return type hint in `AllProviderTest::providerKeys()` from `array<string, array{string}>` to `list<array{string}>`.
4. **Quality Assurance**:
    - Ran `make test-unit` and `make test-functional` (All passed).
    - Ran `make phpstan` (No errors).
    - Ran `make cs-fix` and `make cs-check` (Coding style verified).

## Git Comment Summary
refactor: use RequestTrait::xmlRequest in XML-based providers

- Refactor Ecb, Nbu, Cbrt, Cbr, Nbr, and Bnb providers to use RequestTrait
- Replace manual XML parsing with $this->xmlRequest()
- Fix PHPStan warning in RequestTrait::xmlRequest
- Fix PHPStan return type hint in AllProviderTest

---

## Prompt
В \App\DTO\RateRequest::validateDateRange значение $minDate нужно получать из запроса к БД на получение минимальной даты из ExchangeRateRepository, обязательно кэшровать на час средствами доктрины

## Implementation Plan
1. **Modified ExchangeRateRepository**:
    - Added `getMinDate()` method to fetch the minimum date from the `exchange_rates` table.
    - Enabled Doctrine result cache for 3600 seconds (1 hour) for this query.
2. **Created Custom Validator**:
    - Implemented `App\Validator\Constraints\MinDate` constraint.
    - Implemented `App\Validator\Constraints\MinDateValidator` to handle service-injected validation using `ExchangeRateRepository`.
3. **Updated RateRequest DTO**:
    - Refactored `validateDateRange` to call the new `MinDate` validation logic via the execution context's validator.
    - This allows keeping the logic triggered from the requested method while adhering to Symfony's dependency injection standards for DTO validation.
4. **Quality Assurance**:
    - Ran `make test-functional` (All passed, 7 tests).
    - Ran `make phpstan` and `make cs-fix`.

## Git Comment Summary
feat: implement dynamic min date validation in RateRequest via ExchangeRateRepository

- Add getMinDate with 1-hour result caching to ExchangeRateRepository
- Create MinDate custom constraint and validator
- Update RateRequest::validateDateRange to use the new dynamic min date validation
