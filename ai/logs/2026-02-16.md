## Prompt
Analyze logs for `make test-integration provider=open_exchange_rates`.
- How to make these logs more readable?
- What is the problem with this test?

## Implementation Plan
1. Ran `make test-integration provider=open_exchange_rates` and analyzed the failure (`EntityManager is closed` due to `UniqueConstraintViolationException`).
2. Identified the root cause:
    - Timezone mismatch in `OpenExchangeRatesProvider` (UTC timestamp converted to local time caused day shift).
    - Missing date normalization in `ProviderImporter` before database checks.
    - Faulty retry logic in `ProviderImporter` that didn't handle closed `EntityManager`.
3. Fixes implemented:
    - Normalized dates to UTC 00:00:00 in multiple providers (`OpenExchangeRates`, `AbstractApi`, etc.).
    - Added date normalization in `ProviderImporter::fetchAndSaveRates` and `saveRates`.
    - Updated `ProviderImporter` to use `ManagerRegistry` and reset the manager if it's closed.
    - Updated `ProviderImporterTest` to match new constructor.
4. Verified with `make test-integration`, `make test-unit`, `make test-functional`, `make phpstan`, and `make cs-fix`.

## Git Comment Summary
Fix date normalization and timezone shifts in providers; improve EntityManager handling in ProviderImporter to prevent crashes on unique constraint violations.

--------
## Prompt
Метод \App\Service\ProviderImporter::saveRates надо упростить максимально и чтоб работал надежно и быстро. поэтому используем прямые запросы в БД с использованием INSERT IGNORE. Добавляем данные пачкой и в транзакции. повторять не надо, исключения не перехватываем.
ЛОгику запроса нужно вынести в репозиторий

## Implementation Plan
1.  Modified `App\Repository\ExchangeRateRepository` to add `saveRatesBatch` method.
    - Uses raw SQL `INSERT IGNORE` for MariaDB.
    - Implements batch insertion of rates.
    - Wraps the operation in a transaction via `EntityManager::wrapInTransaction`.
2.  Simplified `App\Service\ProviderImporter`.
    - Removed manual entity creation, loop, and retry logic in `saveRates`.
    - `saveRates` now directly calls `$this->repository->saveRatesBatch`.
    - Removed unused dependencies: `ManagerRegistry`, `UniqueConstraintViolationException`, and `ExchangeRate` entity.
3.  Updated `App\Tests\Unit\Service\ProviderImporterTest`.
    - Updated constructor calls and mocks.
    - Adjusted date/time expectations to match the 12:00 normalization in `ProviderImporter`.
    - Changed expectations from `persist`/`flush` to `saveRatesBatch`.
4.  Verified with QA tools:
    - `make test-unit`
    - `make test-functional`
    - `make phpstan`
    - `make cs-fix`
    - `make cs-check`

## Git Comment Summary
Refactor: Simplify ProviderImporter::saveRates and use batch INSERT IGNORE in repository.
- Move rate saving logic to ExchangeRateRepository::saveRatesBatch using raw SQL.
- Remove retry logic and manual entity management from ProviderImporter.
- Update unit tests to reflect architectural changes and date normalization.

--------
## Prompt
Выполни интеграционные тесты. Если ошибка не исправима и связана with ограничениями API, то нужно добавить об этом в комментарий PHPDOC к описанию провайдера. Добавить метод isActive() в ProviderInterface, и отключить те методы которые не работают, с описанием почему не работают.

## Implementation Plan
1. Added `isActive(): bool` method to `ProviderInterface`.
2. Implemented `isActive()` in all provider classes.
3. Identified failing providers via `make test-integration`.
4. Disabled `BnbProvider` (returns HTML instead of XML) and documented it in PHPDOC.
5. Disabled `CurrencyLayerProvider` (returns 429) and documented it in PHPDOC.
6. Disabled `ApiLayerFixerProvider`, `ApiLayerCurrencyDataProvider`, `ApiLayerExchangeRatesDataProvider` (return 401) and documented it in PHPDOC.
7. Disabled `AbstractApiProvider` (returns 422) and documented it in PHPDOC.
8. Updated `ProviderRegistry` to throw `DisabledProviderException` for inactive providers.
9. Updated `AllProviderTest` to skip inactive providers instead of failing.
10. Uncommented `BnbProvider` in `services.yaml` to allow its discovery and status checking.
11. Cleaned up `BnbProvider` constructor to satisfy PHPStan.
12. Verified all tests (unit, functional, integration) and static analysis (phpstan, cs-fix).

## Git Comment Summary
feat: add isActive method to ProviderInterface and disable failing providers

- Add isActive(): bool to ProviderInterface
- Implement isActive() in all providers
- Disable BnbProvider (invalid response format)
- Disable CurrencyLayer (rate limit reached)
- Disable ApiLayer and AbstractApi providers (invalid/unsupported keys)
- Update ProviderRegistry to respect isActive status
- Update integration tests to skip inactive providers

--------
## Prompt
Добавь в ProviderInterface методы чтобы можно было указывать лимит запросов N, с указанием периода в сек. Добавь логику в \App\Message\FetchRateMessage::getStamps() : Если запросы к данному провайдеру достигли лимита N-10, то добавлять задержку с учетом указанного периода. Логику работу с лимитами реализовать в отдельном классе сделанным по аналогии с \App\Cache\SkipDayCache. Подготовь план реализации с тщательно продуманной архитектурой в проекта и требованиями.

## Implementation Plan
1.  **Interface Update**: Added `getRequestLimit(): int` and `getRequestLimitPeriod(): int` to `ProviderInterface`.
2.  **Bulk Provider Update**: Implemented limit methods in all providers using a PHP script.
    *   Banks (CBR, ECB, etc.) set to 0 (unlimited).
    *   External APIs set to 100 requests per 86400 seconds (1 day).
3.  **RateLimitCache Service**: Created `RateLimitCacheInterface` and `RateLimitCache` class.
    *   Uses window-based keys: `rate_limit_{provider}_{window_id}`.
    *   Window ID calculated as `(int)(time() / period)`.
    *   Stored in `secondCache` (Redis).
4.  **Message Logic**: Updated `FetchRateMessage::getStamps()` to check limits.
    *   Signature updated to accept `RateLimitCacheInterface` and `ProviderInterface`.
    *   If count >= N-10, adds `DelayStamp` with $period/10$ seconds.
5.  **Service Integration**:
    *   `ProviderImporter`: Now increments limit counter after successful API calls.
    *   `ProviderManager`, `FetchRateHandler`, `FetchHistoricalRatesCommand`: Updated to pass cache and provider objects to message stamps.
6.  **Testing**:
    *   Updated `ProviderImporterTest` and `ProviderManagerTest` to include mocked `RateLimitCacheInterface`.
    *   Verified with `make phpstan`, `make test-unit`, `make test-functional`.

## Git Comment Summary
feat: implement rate limiting for providers

- Add limit methods to ProviderInterface
- Create RateLimitCache service for tracking requests
- Add auto-delay logic to FetchRateMessage stamps when near limit
- Increment request counters in ProviderImporter
- Update related services and commands to support rate limiting

--------
## Prompt
Напиши команду, которая бы по всем доступным провайдерам , выполняля запрос на получение курсов за сегодня, и из полученных валютных курсов сравнивала бы с getAvailableCurrencies() провайдера, если есть расхождения - заменяла бы на новый полученный список.

## Implementation Plan
1.  **Command Creation**: Developed `App\Command\SyncProviderCurrenciesCommand`.
    *   Injects `ProviderRegistry` and `CacheInterface`.
    *   Iterates through all `ProviderEnum` cases.
2.  **Sync Logic**:
    *   Skips disabled providers.
    *   Fetches actual rates for today using `$provider->getRates()`.
    *   Compares keys of the returned rates with the current `getAvailableCurrencies()` list.
3.  **Code Modification**:
    *   Used `ReflectionClass` to locate the source file of each provider.
    *   Used `preg_replace` to update the method body of `getAvailableCurrencies()` with the new sorted currency list.
    *   Executed `make cs-fix` to ensure updated files comply with project coding standards.
4.  **Cache Management**: Clears the `providers` cache key in `fastCache` if any updates were made.
5.  **Verification**: Ran the command and verified successful updates for multiple providers (`cbr`, `cbrt`, `nbg`, etc.).

## Git Comment Summary
feat: add app:sync-provider-currencies command

- Create command to sync hardcoded available currencies with real API data
- Implement automatic PHP file modification for providers
- Add automatic cache clearing after updates
- Update currency lists for several providers (CBR, NBG, OpenExchange, etc.)

--------
## Prompt
Добавь правило в AGENTS.md : при добавлении консольной команды symfony, также добавлять его в makefile.

## Implementation Plan
1.  **Documentation Update**: Added a new rule to `AGENTS.md` under "Environment & Commands" requiring that any new Symfony console command must be added to the `Makefile`.
2.  **Rule Adherence**: Updated the `Makefile` to include the `sync-provider-currencies` command (created in the previous session) as a proactive measure.
3.  **AGENTS.md Reference**: (Optional but good practice) I'll also add it to the reference section in `AGENTS.md`.

## Git Comment Summary
docs: add rule for Symfony commands in Makefile

- Update AGENTS.md with mandatory Makefile shortcut rule
- Add sync-provider-currencies to Makefile

--------
## Prompt
добавь https://github.com/frankdekker/symfony-log-viewer-bundle для дев окружения только для просмотра логов

## Implementation Plan
1. Identified correct package name: `fdekker/log-viewer-bundle`.
2. Added `composer-require` command to `Makefile`.
3. Installed `fdekker/log-viewer-bundle` as dev dependency using `make composer-require name="fdekker/log-viewer-bundle --dev"`.
4. Manually registered `FD\LogViewer\FDLogViewerBundle` in `app/config/bundles.php` for `dev` environment.
5. Created `app/config/routes/fd_log_viewer.yaml` to import bundle routes with `/log-viewer` prefix only in `dev`.
6. Installed bundle assets using `make console cmd="assets:install"`.
7. Verified routes using `debug:router`.
8. Fixed pre-existing PHPStan errors in `FetchHistoricalRatesCommand`, `SyncProviderCurrenciesCommand`, and `FetchRateHandler`.
9. Verified all tests and quality checks (unit, functional, phpstan, cs-check).

## Git Comment Summary
Add fdekker/log-viewer-bundle for dev environment and fix pre-existing PHPStan issues.

--------
## Prompt
Для провайдеров нужно добавить еще метод getRequestDelay():int , по умолчанию у всех 1 сек,
Включить его в \App\MessageHandler\FetchRateHandler::__invoke там где TODO

## Implementation Plan
1.  Modified `App\Contract\ProviderInterface` to add `getRequestDelay(): int`.
2.  Implemented `getRequestDelay()` returning `1` in all provider classes in `App\Provider/`.
3.  Updated `App\MessageHandler\FetchRateHandler::__invoke` to use `$provider->getRequestDelay()` for setting the delay when fetching the previous day's rates.
4.  Executed `make cs-fix` to maintain coding standards.
5.  Verified changes with `make phpstan`, `make test-unit`, and `make test-functional`.

## Git Comment Summary
Add getRequestDelay() to ProviderInterface and all providers; use it in FetchRateHandler.

--------
## Prompt
Нужно настроить ratelimit для
/api/v1/rate - 10 запросов за 60 сек
/api/v1/timeseries - 20 запросов за 120сек

## Implementation Plan
1.  Modified `app/config/packages/rate_limiter.yaml` to add `api_rate` and `api_timeseries` limiters.
2.  Updated `App\Controller\RateController` to use these limiters:
    *   Injected `RateLimiterFactory` for each endpoint using `#[Autowire(service: 'limiter.api_rate')]` and `#[Autowire(service: 'limiter.api_timeseries')]`.
    *   Added IP-based rate limit checks at the beginning of `getRate` and `getTimeseries` methods.
    *   Throws `TooManyRequestsHttpException` when the limit is exceeded.
3.  Verified changes with `make phpstan`, `make test-functional`, and `make cs-fix`.

## Git Comment Summary
Configure rate limiting for API endpoints: 10 req/60s for /rate, 20 req/120s for /timeseries.

--------
## Prompt
1) Проведи ревью проекта.
2) Обнови и сверь актуальную информацию в README.md, AGENTS.md , ARCHITECTURE.md
3) напиши про новый релиз в CHANGELOG.md по результам сделанного в последнем коммите.

## Implementation Plan
1.  **Project Review**: 
    - Analyzed recent architectural changes (renaming RateSource to Provider, batch operations).
    - Documented findings in `ai/REVIEW.md`, highlighting strengths and medium-priority improvements (database batch limits, sync safety).
2.  **Documentation Update**:
    - Updated `README.md`: Fixed architecture link, added `/timeseries` and `/providers` endpoint documentation.
    - Updated `ai/ARCHITECTURE.md`: Added details on provider resilience (`isActive`, `getRequestDelay`) and rate limiting.
    - Verified `AGENTS.md`: Confirmed it aligns with current operational workflows.
3.  **Changelog Maintenance**:
    - Updated `CHANGELOG.md`: Added "Release version 0.2" with a comprehensive list of improvements from recent commits (multi-provider support, snake_case API, batch processing, etc.).
4.  **QA Verification**:
    - Ran `make test-unit`, `make test-functional`, `make phpstan`, `make cs-fix`, and `make cs-check` to ensure full compliance with project standards.

## Git Comment Summary
docs: project review and documentation update for Release 0.2
- Conduct code review and save results to ai/REVIEW.md
- Update README.md with new API endpoints and fixed links
- Enhance ARCHITECTURE.md with resilience and rate limiting details
- Document major changes in CHANGELOG.md for version 0.2
